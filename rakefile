desc "Run the unit tests"
task :test do
  
  name    = ENV['NAME']    || 'iPhone'
  version = ENV['VERSION'] || '9.0'
  
  sh "set -o pipefail && xcodebuild -scheme Expectation \
  -target Expectation \
  -destination id=#{Simulator.random(match: name, version: version.to_f).udid} \
  -sdk iphonesimulator \
  test | bundle exec xcpretty"
  
end

class Simulator
  
  attr_accessor :name, :type, :version, :udid
  
  def initialize captures
    @name, @type, @version, @udid = captures
  end
  
  def self.random ignore: /travis|watch|tv/i, match: 'iPhone', version: 8.0
    
    pattern = %r{ ^([\w\-]+)\s+(.*)\s+\((.*)\) .* \[(.*)\] }x

    Simulator.new IO.popen("xcrun instruments -s | cat").reject  { |line| 
      ignore =~ line || pattern !~ line 
    }.map { |line| 
      pattern.match(line).captures 
    }.select { |capture| 
      capture[2].to_f > version && capture[2].to_f < version + 1 and capture[0].include?(match)
    }.sample
    
  end
  
  def to_s
    "#{name} #{type} #{version} [#{udid}]"
  end
  
end 
