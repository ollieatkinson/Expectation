require_relative 'lib/simulator'
require_relative 'lib/bin_available'

desc "Run the unit tests"
task :test do
  
  name    = ENV['NAME']
  version = ENV['VERSION']
  
  simulator = nil

  if name.nil? || version.nil?
    simulator = Simulator.random(match: /^iPhone 6$/, min_version: 9.0, max_version: 9.9)
  else 
    simulator = Simulator.random(match: /^#{name}$/, min_version: version.to_f, max_version: (version.to_f + 1).floor)
  end

  sh "set -o pipefail && " +
  "xcodebuild -scheme Expectation " +
              "-target Expectation " +
              "-destination id=#{simulator.udid} " +
              "-enableCodeCoverage YES " +
              "GCC_INSTRUMENT_PROGRAM_FLOW_ARCS=YES " +
              "ONLY_ACTIVE_ARCH=YES " +
              "VALID_ARCHS=x86_64 " +
              "-sdk iphonesimulator test | bundle exec xcpretty -c"
  
end

desc "Install dependencies"
task :install do
  
  sh "bundle install"
  sh "brew install swiftlint" unless bin_available? "swiftlint"
  
end

namespace :project do
  
  desc "Sort the project file and create determanistic file hashes"
  task :unique do 
    sh "xcunique Expectation.xcodeproj/project.pbxproj"
  end
  
end
